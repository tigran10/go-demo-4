pipeline {
    agent {
        kubernetes {
            label "builder-pod-${UUID.randomUUID().toString()}"
            defaultContainer 'jnlp'
            yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    some-label: builder-pod
spec:
  containers:
  - name: helm
    image: vfarcic/helm:2.8.2
    command:
    - cat
    tty: true
  - name: golang
    image: golang:1.9
    command: ["cat"]
    tty: true
  - name: git
    image: alpine/git
    command:
    - cat
    tty: true
  - name: gren
    image: digitalinside/gren:latest
    command:
    - cat
    tty: true    
  - name: kubectl
    image: vfarcic/kubectl
    command: ["cat"]
    tty: true
  - name: docker
    image: docker
    command:
    - cat
    tty: true
    volumeMounts:
    - mountPath: /var/run/docker.sock
      name: docker-sock-volume
  volumes:
  - name: docker-sock-volume
    hostPath:
      path: /var/run/docker.sock
      type: File
"""
        }
    }

    parameters {
        string(name: 'project', defaultValue: 'go-demo-3')
        string(name: 'image', defaultValue: 'digitalinside/go-demo-3')
        string(name: 'domain', defaultValue: '192.168.0.10.nip.io')
        string(name: 'addr', defaultValue: 'go-demo-3.192.168.0.10.nip.io')
        string(name: 'cmAddr', defaultValue: 'cm.4.192.168.0.10.nip.io')
        string(name: 'chartVer', defaultValue: '0.0.1')
    }

    options {
        timeout(time: 45, unit: 'MINUTES')
    }

    stages {

        stage('build') {
            steps {
                ciPrettyBuildNumber()

                container('git') {
                    ciWithGitKey('TM_RSA') {
                        ciBuildEnvVars()
                    }
                }

                container('docker') {
                    //for feature branch
                    ciK8sBuildImage(params.image, false, env.BUILD_TAG)
                }
            }
        }

        stage("func-test") {
            steps {
                container("helm") {
                    ciK8sUpgradeBeta(params.project, params.domain, env.BUILD_TAG)
                }

                container("kubectl") {
                    ciK8sRolloutBeta(params.project)
                }

                container("golang") {
                    ciK8sFuncTestGolang(params.project, params.domain)
                }
            }

            post {
                failure {
                    container("helm") {
                        ciK8sDeleteBeta(params.project)
                    }
                }
            }
        }


        stage("deploy2uat") {
            when {
                anyOf {
                    branch "master"
                    branch "hotfix-*"
                }
            }

            steps {
                script {
                    container("git") {
                        ciWithGitKey('TM_RSA') {
                            env.RELEASE_TAG = ciSuggestVersion(ciVersionRead())
                        }
                    }

                    // you can have your master builds running for some time until someone decides to promote it.
                    // better to autodelete the deployment when it times out
                    ciDeleteAfterTimingOut(2, 'MINUTES') {
                        env.userInput = input(id: "Deploy Gate", message: "Deploy ${params.project} to UAT?", ok: 'Deploy')


//                        ######### untested for now  #########

//                        container("helm") {
//                            k8sPushHelm(params.project, env.RELEASE_TAG, params.cmAddr)
//                        }
//                        container("helm") {
//                            ciK8sUpgrade(props.project, props.addr, "${project}-uat")
//                        }
//                        container("kubectl") {
//                            ciK8sRollout(props.project, "${project}-uat")
//                        }
//                        container("golang") {
//                            k8sUatTestGolang(props.addr)
//                        }
//                       ##################

                        //docker tag
                        container('docker') {
                            ciRetag(env.BUILD_TAG, false, ["latest", "${env.shortGitCommit}", env.RELEASE_TAG])
                        }

                        //git tag
                        container('git') {
                            ciWithGitKey('TM_RSA') {
                                ciTagGitRelease(env.RELEASE_TAG)
                            }
                        }

                        container('gren') {
                            //https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/
                            withCredentials([string(credentialsId: 'GITHUB_TOKEN', variable: 'TOKEN')]) {
                                sh "gren release --token=${TOKEN}"
                            }
                        }
                    }
                }
            }
        }

        stage("clean up") {
            when {
                not {
                    anyOf {
                        branch "master"
                        branch "hotfix-*"
                    }
                }
            }

            steps {
                script {

                    // this will delete feature branch deployments, unless someone wants to keep it running
                    // later it should be deleted manually, or with PR merge hook
                    ciDeleteAfterTimingOut(1, 'MINUTES') {
                        env.userInput = input(id: "delete deployment", message: "Delete ${env.BRANCH_NAME} deployment?", ok: 'Delete')
                        ciK8sDeleteBeta(params.project)
                    }
                }

            }
        }

    }
}